{% set days = upcoming_days() %}
{% set selected_date = request.args.get('date', '') %}
{% if not selected_date and days %}
  {% set selected_date = days[0].strftime('%Y-%m-%d') %}
{% endif %}
{% set selected_status = request.args.get('status', 'available') %}
{% set weekday_labels = {
  'Mon': 'LUN',
  'Tue': 'MAR',
  'Wed': 'MIE',
  'Thu': 'JUE',
  'Fri': 'VIE',
  'Sat': 'SAB',
  'Sun': 'DOM'
} %}
<form id="filters-form">
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
    <input type="hidden" name="category" value="{{ request.args.get('category', category.slug if category else '') }}">
    <div>
      <label class="form-label">Fecha</label>
      <input type="date"
             name="date"
             class="form-input"
             value="{{ selected_date }}"
             hx-get="{{ url_for('ui.turnos_table') }}"
             hx-target="#turnos-container"
             hx-include="#filters-form input[name], #filters-form select[name]"
             hx-trigger="change delay:200ms"
             hx-push-url="true">
    </div>

    <div>
      <label class="form-label">Estado</label>
      <select name="status"
              class="form-input"
              hx-get="{{ url_for('ui.turnos_table') }}"
              hx-target="#turnos-container"
              hx-include="#filters-form input[name], #filters-form select[name]"
              hx-trigger="change"
              hx-push-url="true">
        <option value="all" {% if selected_status == 'all' %}selected{% endif %}>Todos</option>
        <option value="available" {% if selected_status == 'available' %}selected{% endif %}>Disponible</option>
        <option value="holding" {% if selected_status == 'holding' %}selected{% endif %}>En espera</option>
        <option value="reserved" {% if selected_status == 'reserved' %}selected{% endif %}>Reservado</option>
        <option value="blocked" {% if selected_status == 'blocked' %}selected{% endif %}>Bloqueado</option>
      </select>
    </div>

    <div>
      <label class="form-label">Complejo</label>
      <input type="text"
             name="complex_slug"
             class="form-input"
             placeholder="Nombre del complejo"
             value="{{ request.args.get('complex_slug', '') }}"
             hx-get="{{ url_for('ui.turnos_table') }}"
             hx-target="#turnos-container"
             hx-include="#filters-form input[name], #filters-form select[name]"
             hx-trigger="change delay:300ms"
             hx-push-url="true">
    </div>

    <div>
      <label class="form-label">Deporte/Servicio</label>
      <input type="text"
             name="sport_service"
             class="form-input"
             placeholder="Buscar..."
             value="{{ request.args.get('sport_service', '') }}"
             hx-get="{{ url_for('ui.turnos_table') }}"
             hx-target="#turnos-container"
             hx-include="#filters-form input[name], #filters-form select[name]"
             hx-trigger="change delay:300ms"
             hx-push-url="true">
    </div>
  </div>

  <div class="mt-6">
    <div class="flex items-center justify-between mb-3">
      <p class="text-sm font-medium text-gray-700">Proximos dias</p>
      <span class="text-xs text-gray-500">Elegi rapido entre hoy y la proxima semana</span>
    </div>
    <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-2" data-quick-day-grid>
      {% for day in days %}
        {% set day_str = day.strftime('%Y-%m-%d') %}
        <button type="button"
                class="quick-day block w-full rounded-lg border border-gray-200 bg-white text-gray-900 p-3 text-left transition hover:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100"
                data-date-option="{{ day_str }}"
                hx-get="{{ url_for('ui.turnos_table') }}"
                hx-target="#turnos-container"
                hx-include="#filters-form input[name], #filters-form select[name]"
                hx-vals='{"date": "{{ day_str }}"}'
                hx-push-url="true">
          <span class="quick-day-label text-xs uppercase text-gray-500">{{ weekday_labels.get(day.strftime('%a'), day.strftime('%a')) }}</span>
          <div class="text-lg font-semibold">{{ day.strftime('%d/%m') }}</div>
        </button>
      {% endfor %}
    </div>
  </div>

  <div class="flex flex-wrap gap-2 items-center mt-6">
    <button type="button"
            class="btn-primary"
            hx-get="{{ url_for('ui.turnos_table') }}"
            hx-target="#turnos-container"
            hx-include="#filters-form input[name], #filters-form select[name]"
            hx-push-url="true">
      Buscar turnos
    </button>
    <button type="button" class="btn-secondary" onclick="this.form.reset(); this.form.dispatchEvent(new Event('reset')); ">
      Limpiar
    </button>
  </div>
</form>

<script>
(function () {
  var form = document.getElementById('filters-form');
  if (!form || form.dataset.quickDaysInit) { return; }
  form.dataset.quickDaysInit = '1';

  var dateInput = form.querySelector("input[name='date']");
  var grid = form.querySelector('[data-quick-day-grid]');
  if (!grid) { return; }

  var buttons = grid.querySelectorAll('[data-date-option]');
  var buttonActiveClasses = ['bg-blue-600', 'text-white', 'border-blue-600', 'shadow-sm'];
  var buttonInactiveClasses = ['bg-white', 'text-gray-900', 'border-gray-200'];

  var labelActiveClasses = ['text-white'];
  var labelInactiveClasses = ['text-gray-500'];

  function setActive(value) {
    buttons.forEach(function (btn) {
      var isActive = value && btn.getAttribute('data-date-option') === value;
      buttonActiveClasses.forEach(function (cls) { btn.classList.toggle(cls, isActive); });
      buttonInactiveClasses.forEach(function (cls) { btn.classList.toggle(cls, !isActive); });
      var label = btn.querySelector('.quick-day-label');
      if (label) {
        labelActiveClasses.forEach(function (cls) { label.classList.toggle(cls, isActive); });
        labelInactiveClasses.forEach(function (cls) { label.classList.toggle(cls, !isActive); });
      }
    });
  }

  buttons.forEach(function (btn) {
    btn.addEventListener('click', function () {
      var value = btn.getAttribute('data-date-option');
      if (dateInput) {
        dateInput.value = value;
      }
      setActive(value);
    });
  });

  form.addEventListener('reset', function () {
    setTimeout(function () {
      if (dateInput) {
        dateInput.value = '';
      }
      setActive('');
    }, 0);
  });

  if (dateInput) {
    dateInput.addEventListener('change', function () {
      setActive(dateInput.value);
    });
  }

  setActive(dateInput ? dateInput.value : '');
})();
</script>
