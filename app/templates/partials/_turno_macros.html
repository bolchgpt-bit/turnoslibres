{% macro status_badge(status_value) %}
  {%- if status_value == 'available' -%}
    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Disponible</span>
  {%- elif status_value == 'holding' -%}
    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Reservando</span>
  {%- elif status_value == 'reserved' -%}
    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Reservado</span>
  {%- else -%}
    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Bloqueado</span>
  {%- endif -%}
{% endmacro %}


{% macro turno_row_daily(timeslot) %}
  <tr>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
      {{ timeslot.start.strftime('%d/%m/%Y %H:%M') }}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
      {% if timeslot.field %}
        {{ timeslot.field.complex.name }} - {{ timeslot.field.name }}
        {% if timeslot.field.sport %}<br><span class="text-gray-500">{{ timeslot.field.sport }}</span>{% endif %}
      {% elif timeslot.service %}
        {{ timeslot.service.name }}
        <br><span class="text-gray-500">{{ timeslot.service.category.title }}</span>
      {% endif %}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
      {% if timeslot.price %}
        ${{ timeslot.price }} {{ timeslot.currency }}
      {% else %}-{% endif %}
    </td>
    <td class="px-6 py-4 whitespace-nowrap" id="status-{{ timeslot.id }}">
      {{ status_badge(timeslot.status.value) }}
      <span id="hold-ct-{{ timeslot.id }}" class="text-xs text-gray-500"></span>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
      {% if timeslot.status.value == 'available' %}
        <span id="hold-ind-{{ timeslot.id }}" class="htmx-indicator text-xs text-gray-500">Procesando…</span>
        <button class="text-blue-600 hover:text-blue-900"
                hx-swap="none"
                hx-post="{{ url_for('api.hold_timeslot') }}"
                hx-include="this"
                hx-vals='{"timeslot_id": "{{ timeslot.id }}"}'
                hx-headers='{"X-CSRFToken": "{{ csrf_token() }}"}'
                hx-indicator="#hold-ind-{{ timeslot.id }}"
                hx-on="htmx:afterRequest from:body: (function(){try{var data=JSON.parse(event.detail.xhr.responseText); if(data && data.success){var st=document.getElementById('status-{{ timeslot.id }}'); if(st){st.innerHTML='<span class=\'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800\'>Reservando</span> <span id=\'hold-ct-{{ timeslot.id }}\' class=\'text-xs text-gray-500\'></span>'; var secs=(parseInt('{{ hold_minutes }}')||15)*60; var el=document.getElementById('hold-ct-{{ timeslot.id }}'); if(el){var iv=setInterval(function(){secs--; if(secs<=0){clearInterval(iv); el.textContent='';} else {var m=Math.floor(secs/60), s=('0'+(secs%60)).slice(-2); el.textContent=' ('+m+':'+s+')';}},1000);} } if(data.whatsapp_url){ window.open(data.whatsapp_url,'_blank'); } } }catch(e){}})">
          Reservar
        </button>
      {% else %}
        <div class="flex items-center space-x-2">
          <input type="email" placeholder="tu@email.com" class="text-xs px-2 py-1 border rounded" id="email-{{ timeslot.id }}">
          <button class="text-blue-600 hover:text-blue-900 text-xs"
                  hx-post="{{ url_for('ui.subscribe') }}"
                  hx-target="#result-{{ timeslot.id }}"
                  hx-include="#email-{{ timeslot.id }}"
                  hx-vals='{"timeslot_id": "{{ timeslot.id }}"}'>
            Avisar
          </button>
        </div>
        <div id="result-{{ timeslot.id }}" class="mt-1"></div>
      {% endif %}
    </td>
  </tr>
{% endmacro %}


{% macro turno_row_weekly(timeslot) %}
  <tr>
    <td class="px-4 py-2 text-sm text-gray-900">{{ timeslot.start.strftime('%H:%M') }}</td>
    <td class="px-4 py-2 text-sm text-gray-900">
      {% if timeslot.field %}
        {{ timeslot.field.complex.name }} - {{ timeslot.field.name }}
      {% elif timeslot.service %}
        {{ timeslot.service.name }}
      {% endif %}
    </td>
    <td class="px-4 py-2 text-sm text-gray-900">
      {% if timeslot.price %}${{ timeslot.price }}{% else %}-{% endif %}
    </td>
    <td class="px-4 py-2" id="status-{{ timeslot.id }}">
      {{ status_badge(timeslot.status.value) }}
      <span id="hold-ct-{{ timeslot.id }}" class="text-xs text-gray-500"></span>
    </td>
    <td class="px-4 py-2 text-sm">
      {% if timeslot.status.value == 'available' %}
        <span id="hold-ind-{{ timeslot.id }}" class="htmx-indicator text-xs text-gray-500">Procesando…</span>
        <button class="text-blue-600 hover:text-blue-900 text-xs"
                hx-swap="none"
                hx-post="{{ url_for('api.hold_timeslot') }}"
                hx-include="this"
                hx-vals='{"timeslot_id": "{{ timeslot.id }}"}'
                hx-headers='{"X-CSRFToken": "{{ csrf_token() }}"}'
                hx-indicator="#hold-ind-{{ timeslot.id }}"
                hx-on="htmx:afterRequest from:body: (function(){try{var data=JSON.parse(event.detail.xhr.responseText); if(data && data.success){var st=document.getElementById('status-{{ timeslot.id }}'); if(st){st.innerHTML='<span class=\'inline-flex items-center px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-800\'>Reservando</span> <span id=\'hold-ct-{{ timeslot.id }}\' class=\'text-xs text-gray-500\'></span>'; var secs=(parseInt('{{ hold_minutes }}')||15)*60; var el=document.getElementById('hold-ct-{{ timeslot.id }}'); if(el){var iv=setInterval(function(){secs--; if(secs<=0){clearInterval(iv); el.textContent='';} else {var m=Math.floor(secs/60), s=('0'+(secs%60)).slice(-2); el.textContent=' ('+m+':'+s+')';}},1000);} } if(data.whatsapp_url){ window.open(data.whatsapp_url,'_blank'); } } }catch(e){}})">
          Reservar
        </button>
      {% else %}
        <div class="flex items-center space-x-1">
          <input type="email" placeholder="email" class="text-xs px-1 py-1 border rounded w-20" id="email-week-{{ timeslot.id }}">
          <button class="text-blue-600 hover:text-blue-900 text-xs"
                  hx-post="{{ url_for('ui.subscribe') }}"
                  hx-target="#result-week-{{ timeslot.id }}"
                  hx-include="#email-week-{{ timeslot.id }}"
                  hx-vals='{"timeslot_id": "{{ timeslot.id }}"}'>
            Avisar
          </button>
        </div>
        <div id="result-week-{{ timeslot.id }}" class="mt-1"></div>
      {% endif %}
    </td>
  </tr>
{% endmacro %}
